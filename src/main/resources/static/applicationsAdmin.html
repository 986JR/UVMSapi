<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UVMS - Admin Applications</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/admin.css">
</head>
<body>
<header>
    <div class="header-left">
        <div class="menu-toggle"><i class="fas fa-bars"></i></div>
        <div class="logo">UDOM Vendor Management System</div>
    </div>
    <div class="header-right">
        <div class="logout-btn"><i class="fas fa-sign-out-alt"></i></div>
    </div>
</header>

<div class="sidebar">
    <div class="sidebar-header">Admin Portal</div>
    <ul class="sidebar-menu">
        <li><a href="Admindashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
        <li><a href="manage-tendersAdmin.html"><i class="fas fa-list"></i> Manage Tenders</a></li>
        <li><a href="#"><i class="fas fa-map-marker-alt"></i> Manage Plots</a></li>
        <li><a href="applicationsAdmin.html" class="active"><i class="fas fa-file-alt"></i> Applications</a></li>
        <li><a href="#"><i class="fas fa-clipboard-check"></i> Application Review</a></li>
        <li><a href="licensesAdimin.html"><i class="fas fa-certificate"></i> Licenses</a></li>
        <li><a href="#"><i class="fas fa-sync-alt"></i> License Renewals</a></li>
        <li><a href="#"><i class="fas fa-book"></i> Policies</a></li>
        <li><a href="#"><i class="fas fa-bell"></i> Notifications</a></li>
        <li><a href="#"><i class="fas fa-key"></i> Change Password</a></li>
    </ul>
</div>

<div class="main-content">
    <div class="content-section">
        <div class="content-header">
            <h2>Applications</h2>
            <p id="vendorName">Loading...</p>
        </div>

        <!-- Category Tabs -->
        <div class="notification-filters">
            <button class="filter-btn active" onclick="filterApps('ALL')">All</button>
            <button class="filter-btn" onclick="filterApps('PENDING')">Pending</button>
            <button class="filter-btn" onclick="filterApps('APPROVED')">Approved</button>
            <button class="filter-btn" onclick="filterApps('DENIED')">Denied</button>
        </div>

        <!-- Application Cards -->
        <div id="applicationsContainer" class="policy-cards"></div>
    </div>
</div>

<!-- Modal -->
<div class="modal" id="appModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Application Details</h3>
            <span class="close-modal" onclick="closeModal()">&times;</span>
        </div>
        <div id="modalDetails" class="modal-details">Loading...</div>
        <div class="app-actions" style="margin-top:20px; display:flex; justify-content:flex-end; gap:10px;">
            <button class="btn approve-btn" onclick="approveApp(currentApp?.application_id)">
                <i class="fas fa-check"></i> Approve
            </button>
            <button class="btn deny-btn" onclick="denyApp(currentApp?.application_id)">
                <i class="fas fa-times"></i> Deny
            </button>
        </div>
    </div>
</div>

<script>
    const apiBase = "https://uvmsapiv1.onrender.com/api";
    const token = localStorage.getItem("jwtToken");
    const authHeaders = { "Authorization": "Bearer " + token, "Content-Type": "application/json" };

    let applications = [];
    let vendors = [];
    let currentApp = null;
    let adminLastName = "";

    // Load Vendor (Admin) Name
    fetch(`${apiBase}/vendors/dashboard`, { headers: authHeaders })
        .then(res => res.json())
        .then(data => {
            adminLastName = data.lastName;
            document.getElementById("vendorName").innerText = `${data.firstName} ${data.lastName}, Admin`;
        });

    // Load Vendors
    fetch(`${apiBase}/vendors`, { headers: authHeaders })
        .then(res => res.json())
        .then(data => vendors = data);

    // Load Applications
    fetch(`${apiBase}/applications`, { headers: authHeaders })
        .then(res => res.json())
        .then(async data => {
            applications = data;
            renderApplications(applications);
        });

    async function renderApplications(apps) {
        const container = document.getElementById("applicationsContainer");
        container.innerHTML = "";

        for (let app of apps) {
            const vendor = vendors.find(v => v.vendorId === app.vendor);
            const vendorName = vendor ? vendor.companyName : "Unknown Vendor";
            const fullName = vendor ? `${vendor.firstName} ${vendor.lastName}` : "";

            // Get Tender Description
            let tenderDescription = "";
            const plotRes = await fetch(`${apiBase}/plots/${app.plot}`, { headers: authHeaders });
            const plot = await plotRes.json();
            const tenderRes = await fetch(`${apiBase}/tenders/${plot.tender}`, { headers: authHeaders });
            const tender = await tenderRes.json();
            tenderDescription = tender.description;

            // Card HTML styled with your CSS
            const card = `
        <div class="policy-card">
          <div class="policy-header">
            <h4>Vendor Registration - ${vendorName}</h4>
            <span class="status-badge status-${app.status.toLowerCase()}">${app.status}</span>
          </div>
          <div class="policy-description">${tenderDescription}</div>
          <div class="policy-meta">
            <span><i class="fas fa-calendar"></i> ${new Date(app.applicationDate).toLocaleDateString()}</span>
            <span><i class="fas fa-user"></i> ${fullName}</span>
          </div>
          <div class="policy-actions">
            <button class="btn btn-sm btn-primary" onclick="openModal(${app.application_id})">
              <i class="fas fa-eye"></i> View
            </button>
            ${app.status === "PENDING" ? `
              <button class="btn btn-sm approve-btn" onclick="approveApp(${app.application_id})">
                <i class="fas fa-check"></i> Approve
              </button>
              <button class="btn btn-sm deny-btn" onclick="denyApp(${app.application_id})">
                <i class="fas fa-times"></i> Deny
              </button>
            ` : ""}
          </div>
        </div>`;
            container.innerHTML += card;
        }
    }

    // Filter by Status
    function filterApps(status) {
        const btns = document.querySelectorAll('.filter-btn');
        btns.forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');

        if (status === "ALL") {
            renderApplications(applications);
        } else {
            renderApplications(applications.filter(app => app.status === status));
        }
    }

    // Modal
    function openModal(appId) {
        currentApp = applications.find(a => a.application_id === appId);
        const vendor = vendors.find(v => v.vendorId === currentApp.vendor);
        const vendorName = vendor ? `${vendor.firstName} ${vendor.lastName}` : "Unknown Vendor";

        document.getElementById("modalDetails").innerHTML = `
      <p><b>Application ID:</b> ${currentApp.application_id}</p>
      <p><b>Status:</b> ${currentApp.status}</p>
      <p><b>Vendor:</b> ${vendorName}</p>
      <p><b>Plot ID:</b> ${currentApp.plot}</p>
      <p><b>Date Submitted:</b> ${new Date(currentApp.applicationDate).toLocaleDateString()}</p>
    `;

        // Show or hide modal buttons depending on status
        const actionsDiv = document.querySelector("#appModal .app-actions");
        if (currentApp.status === "PENDING") {
            actionsDiv.style.display = "flex";
        } else {
            actionsDiv.style.display = "none";
        }

        document.getElementById("appModal").style.display = "flex";
    }
    function closeModal() { document.getElementById("appModal").style.display = "none"; }

    // Approve
    async function approveApp(appId) {
        const app = applications.find(a => a.application_id === appId);

        const updatedApp = {
            ...app,
            status: "APPROVED",
            reviewedBy: adminLastName,
            reviewedAt: new Date().toISOString(),
            feedback: "Congrats Welcome To UDOM investments"
        };

        await fetch(`${apiBase}/applications/${appId}`, {
            method: "PUT", headers: authHeaders, body: JSON.stringify(updatedApp)
        });

        const licensePayload = {
            application: { application_id: app.application_id },
            vendor: { vendorId: app.vendor },
            licenseNumber: `LIC-${new Date().getFullYear()}-${appId}`,
            issueDate: new Date().toISOString(),
            expiryDate: new Date(new Date().setFullYear(new Date().getFullYear() + 1)).toISOString(),
            licenseFilePath: "/licenses/generated_license.pdf",
            isActive: true,
            renewalRequests: []
        };

        await fetch(`${apiBase}/licenses`, {
            method: "POST",
            headers: authHeaders,
            body: JSON.stringify(licensePayload)
        });

        alert("Application Approved & License Created");
        location.reload();
    }

    // Deny
    function denyApp(appId) {
        const app = applications.find(a => a.application_id === appId);
        const payload = {
            ...app,
            status: "DENIED",
            reviewedBy: adminLastName,
            reviewedAt: new Date().toISOString(),
            feedback: "Sorry, try another one!",
            license: null
        };
        fetch(`${apiBase}/applications/${appId}`, {
            method: "PUT", headers: authHeaders, body: JSON.stringify(payload)
        }).then(() => { alert("Application Denied"); location.reload(); });
    }
</script>


</body>
</html>
