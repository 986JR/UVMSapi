<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tender Details | UDOM Vendor Management System</title>
    <link rel="stylesheet" href="css/vendor-styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
<div class="sidebar">
    <div class="sidebar-header"><h3>UVMS</h3></div>
    <nav class="sidebar-nav">
        <a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
        <a href="colleges.html" class="active"><i class="fas fa-university"></i> Tenders</a>
        <a href="applications.html"><i class="fas fa-clipboard-list"></i> Applications</a>
        <a href="licenses.html"><i class="fas fa-certificate"></i> Licenses</a>
        <a href="contracts.html"><i class="fas fa-file-signature"></i> Contracts</a>
        <a href="policies.html"><i class="fas fa-book"></i> Policies</a>
        <a href="notifications.html"><i class="fas fa-bell"></i> Notifications</a>
        <a href="../../index.html"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </nav>
</div>

<nav class="navbar">
    <button class="mobile-menu-toggle"><i class="fas fa-bars"></i></button>
    <div class="navbar-brand">Tender Details</div>
    <div class="navbar-user">
        <div class="user-avatar" id="userAvatar">JD</div>
        <span id="userName">John Doe</span>
    </div>
</nav>

<div class="main-content">
    <div class="flex flex-between align-center mb-3 flex-mobile-stack">
        <div class="mb-mobile-2">
            <h1 id="tenderTitle" style="margin-bottom:5px;"></h1>
            <p id="tenderMeta" style="color:var(--uvms-text-secondary-light);margin:0;font-size:0.9em;"></p>
        </div>
        <a href="colleges.html" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Go Back
        </a>
    </div>

    <div class="grid grid-2 gap-3">
        <div>
            <div class="card mb-3">
                <div class="card-header"><h3>Basic Information</h3></div>
                <div class="card-body">
                    <div class="grid grid-2 gap-2">
                        <div><small>Tender ID:</small><p id="tenderId" style="margin:0;font-weight:500;"></p></div>
                        <div><small>College:</small><p id="collegeName" style="margin:0;font-weight:500;"></p></div>
                        <div><small>Created By:</small><p id="createdBy" style="margin:0;font-weight:500;"></p></div>
                        <div><small>Created At:</small><p id="createdAt" style="margin:0;font-weight:500;"></p></div>
                        <div><small>Status:</small><p id="status" style="margin:0;font-weight:500;"></p></div>
                        <div><small>Deadline:</small><p id="deadline" style="margin:0;font-weight:500;color:var(--uvms-danger-red);"></p></div>
                    </div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header"><h3>Description</h3></div>
                <div class="card-body">
                    <p id="description" style="color:var(--uvms-text-secondary-light);line-height:1.6;"></p>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header"><h3>Available Plots</h3></div>
                <div class="card-body" id="plotsContainer"></div>
            </div>
        </div>

        <div>
            <div class="card mb-3">
                <div class="card-header"><h3>Actions</h3></div>
                <div class="card-body">
                    <div class="flex" style="flex-direction:column;gap:10px;">
                        <button class="btn btn-primary"><i class="fas fa-download"></i> Download Contract Template</button>
                        <button class="btn btn-success" onclick="openApplicationModal()"><i class="fas fa-paper-plane"></i> Submit Application</button>
                        <button class="btn btn-secondary"><i class="fas fa-question-circle"></i> Request Information</button>
                    </div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header"><h3>Timeline</h3></div>
                <div class="card-body" id="timeline"></div>
            </div>

            <div class="card">
                <div class="card-header"><h3>Requirements</h3></div>
                <div class="card-body">
                    <ul style="color:var(--uvms-text-secondary-light);padding-left:20px;">
                        <li>Minimum 5 years experience in similar projects</li>
                        <li>Tax compliance certificate</li>
                        <li>Company registration documents</li>
                        <li>Signed copy of contract template</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Application Modal -->
<div id="applicationModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
    <div class="modal-content" style="background: white; padding: 20px; width: 90%; max-width: 500px;">
        <div class="modal-header" style="border-bottom: 1px solid var(--uvms-surface-dark); padding-bottom: 15px; margin-bottom: 15px;">
            <h3 style="margin: 0;">Submit Application</h3>
            <span class="close" onclick="closeApplicationModal()" style="float: right; font-size: 24px; cursor: pointer;">&times;</span>
        </div>
        <div class="modal-body">
            <p style="color: var(--uvms-text-secondary-light); margin-bottom: 15px;">
                You are applying for: <strong id="modalTenderTitle"></strong> (<span id="modalTenderId"></span>)
            </p>

            <div class="form-group">
                <label for="plotSelection" class="form-label">Select Plot</label>
                <select class="form-input" id="plotSelection" required>
                    <option value="">Select a plot</option>
                </select>
            </div>

            <div class="form-group">
                <label for="signedContract" class="form-label">Upload Signed Contract (PDF or Word)</label>
                <input type="file" class="form-input" id="signedContract" accept=".pdf,.doc,.docx" required>
                <small style="color: var(--uvms-text-secondary-light);">Make sure to merge the required documents with the signed contract before attaching.</small>
            </div>
        </div>
        <div class="modal-footer" style="border-top: 1px solid var(--uvms-surface-dark); padding-top: 15px; margin-top: 15px;">
            <button type="button" class="btn btn-secondary" onclick="closeApplicationModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="submitApplication()">Submit Application</button>
        </div>
    </div>
</div>

<script>
    const apiBase = "https://uvmsapiv1.onrender.com/api";
    const token = localStorage.getItem("jwtToken");

    function getQueryParams() {
        const params = new URLSearchParams(window.location.search);
        return { tenderId: params.get("tenderId"), collegeId: params.get("collegeId") };
    }

    async function loadUser() {
        try {
            const res = await fetch(`${apiBase}/vendors/dashboard`, {
                headers: { "Authorization": "Bearer " + token }
            });
            if (!res.ok) return;
            const user = await res.json();
            document.getElementById("userName").textContent = user.firstName + " " + user.lastName;
            document.getElementById("userAvatar").textContent = (user.firstName[0] + user.lastName[0]).toUpperCase();
        } catch (e) {
            console.error("User load error", e);
        }
    }

    async function loadTenderDetails() {
        const { tenderId, collegeId } = getQueryParams();
        try {
            const tenderRes = await fetch(`${apiBase}/tenders/${tenderId}`);
            const collegeRes = await fetch(`${apiBase}/colleges/${collegeId}`);
            const plotsRes = await fetch(`${apiBase}/plots`, {
                headers: { "Authorization": "Bearer " + token }
            });

            if (!tenderRes.ok || !collegeRes.ok) {
                throw new Error("Failed to fetch tender or college");
            }

            const tender = await tenderRes.json();
            const college = await collegeRes.json();
            const allPlots = plotsRes.ok ? await plotsRes.json() : [];

            const plots = allPlots.filter(p => String(p.tender) === String(tenderId));

            document.getElementById("tenderTitle").textContent = tender.title;
            document.getElementById("tenderMeta").textContent = `Tender ID: ${tender.tender_id} | ${college.college_name}`;
            document.getElementById("tenderId").textContent = tender.tender_id;
            document.getElementById("collegeName").textContent = college.college_name;
            document.getElementById("createdBy").textContent = tender.createdBy?.name || "N/A";
            document.getElementById("createdAt").textContent = new Date(tender.createdAt).toLocaleString();

            let statusClass = "badge-secondary";
            if (tender.status === "ACTIVE") statusClass = "badge-success";
            if (tender.status === "EXPIRED") statusClass = "badge-danger";
            if (tender.status === "PENDING") statusClass = "badge-warning";
            if (tender.status === "REJECTED") statusClass = "badge-dark";
            document.getElementById("status").innerHTML = `<span class="badge ${statusClass}">${tender.status}</span>`;

            document.getElementById("deadline").textContent = new Date(tender.deadlineDate).toLocaleString();
            document.getElementById("description").textContent = tender.description;

            // Fill plots main section
            const plotsContainer = document.getElementById("plotsContainer");
            plotsContainer.innerHTML = "";
            if (!plots || plots.length === 0) {
                plotsContainer.innerHTML = `<p style="color:var(--uvms-text-secondary-light);">No plots available for this tender</p>`;
            } else {
                plots.forEach(plot => {
                    const div = document.createElement("div");
                    div.className = "plot-item mb-2";
                    div.style = "padding:12px;border-left:4px solid var(--uvms-success-green);background:var(--uvms-surface-light);";
                    div.innerHTML = `
                        <h4 style="margin:0;font-size:1em;">${plot.plotNumber}</h4>
                        <p style="margin:5px 0;color:var(--uvms-text-secondary-light);">${plot.locationDescription}</p>
                        <small style="color:var(--uvms-text-secondary-light);">Available: ${plot.isAvailable}</small>`;
                    plotsContainer.appendChild(div);
                });
            }

            // Timeline
            const timeline = document.getElementById("timeline");
            timeline.innerHTML = `
                <div class="timeline-item" style="padding:10px 0;border-left:2px solid var(--uvms-blue-primary);padding-left:15px;position:relative;">
                    <div style="position:absolute;left:-6px;top:12px;width:10px;height:10px;background:var(--uvms-blue-primary);border-radius:50%;"></div>
                    <small>${new Date(tender.createdAt).toLocaleDateString()}</small>
                    <p style="margin:5px 0;font-weight:500;">Tender Published</p>
                </div>
                <div class="timeline-item" style="padding:10px 0;padding-left:15px;position:relative;">
                    <div style="position:absolute;left:-6px;top:12px;width:10px;height:10px;background:var(--uvms-text-secondary-light);border-radius:50%;"></div>
                    <small>${new Date(tender.deadlineDate).toLocaleDateString()}</small>
                    <p style="margin:5px 0;font-weight:500;color:var(--uvms-danger-red);">Submission Deadline</p>
                </div>`;

            // Modal plots
            const plotSelection = document.getElementById("plotSelection");
            plotSelection.innerHTML = '<option value="">Select a plot</option>';
            plots.forEach(plot => {
                if (plot.isAvailable) {
                    const option = document.createElement("option");
                    option.value = plot.plot_id;
                    option.textContent = `${plot.plotNumber} (${plot.locationDescription})`;
                    plotSelection.appendChild(option);
                }
            });

            document.getElementById("modalTenderTitle").textContent = tender.title;
            document.getElementById("modalTenderId").textContent = tender.tender_id;

        } catch (e) {
            console.error("Tender load error", e);
        }
    }

    function openApplicationModal() {
        document.getElementById("applicationModal").style.display = "flex";
    }

    function closeApplicationModal() {
        document.getElementById("applicationModal").style.display = "none";
    }

    async function submitApplication() {
        const submitBtn = document.querySelector('#applicationModal .btn-primary');
        const plot = document.getElementById("plotSelection").value;
        const contractFile = document.getElementById("signedContract").files[0];
        const tenderId = new URLSearchParams(window.location.search).get("tenderId");

        if (!plot || !contractFile) {
            alert("Please select a plot and upload the signed contract");
            return;
        }

        if (!token) {
            alert("You must be logged in to submit an application.");
            window.location.href = "login.html";
            return;
        }

        submitBtn.disabled = true;
        const originalText = submitBtn.textContent;
        submitBtn.textContent = "Submitting...";

        const formData = new FormData();
        formData.append("plot", plot);
        formData.append("tenderId", tenderId);
        formData.append("signedContract", contractFile, contractFile.name);

        try {
            const res = await fetch(`${apiBase}/applications`, {
                method: "POST",
                headers: { "Authorization": "Bearer " + token },
                body: formData
            });

            if (res.status === 401) {
                alert("Session expired. Please log in again.");
                window.location.href = "login.html";
                return;
            }

            if (!res.ok) {
                let errMsg = `Request failed (${res.status})`;
                try {
                    const errJson = await res.json();
                    errMsg = errJson.message || JSON.stringify(errJson);
                } catch (_) {}
                throw new Error(errMsg);
            }

            const data = await res.json();
            alert(data.message || "Application submitted successfully!");
            closeApplicationModal();
            setTimeout(() => window.location.href = "applications.html", 800);

        } catch (err) {
            console.error("Submit error:", err);
            alert("Failed to submit application: " + (err.message || err));
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    }

    window.onclick = function(event) {
        const modal = document.getElementById("applicationModal");
        if (event.target === modal) {
            closeApplicationModal();
        }
    };

    loadUser();
    loadTenderDetails();
</script>
</body>
</html>
