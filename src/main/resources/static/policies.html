<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Policies | University Vendor Management System</title>
    <link rel="stylesheet" href="css/vendor-styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
<!-- Mobile Menu Toggle -->
<button class="mobile-menu-toggle" id="mobileMenuToggle">
    <i class="fas fa-bars"></i>
</button>

<!-- Sidebar -->
<div class="sidebar">
    <div class="sidebar-header">
        <h3>UVMS</h3>
    </div>
    <nav class="sidebar-nav">
        <a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
        <a href="colleges.html"><i class="fas fa-university"></i> Tenders</a>
        <a href="applications.html"><i class="fas fa-clipboard-list"></i> Applications</a>
        <a href="licenses.html"><i class="fas fa-certificate"></i> Licenses</a>
        <a href="contracts.html"><i class="fas fa-file-signature"></i> Contracts</a>
        <a href="policies.html" class="active"><i class="fas fa-book"></i> Policies</a>
        <a href="notifications.html"><i class="fas fa-bell"></i> Notifications</a>
        <a href="" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </nav>
</div>

<!-- Navbar -->
<nav class="navbar">
    <div class="navbar-brand">Policies & Guidelines</div>
    <div class="navbar-user">
        <div class="user-avatar" id="userAvatar">JD</div>
        <span id="userName">John Doe</span>
    </div>
</nav>

<!-- Main Content -->
<div class="main-content">
    <div class="flex flex-between align-center mb-3 flex-mobile-stack">
        <div class="mb-mobile-2">
            <h1 style="margin-bottom: 5px;">Policies & Guidelines</h1>
            <p style="color: var(--uvms-text-secondary-light); margin: 0; font-size: 0.9em;">
                Review university policies and compliance requirements
            </p>
        </div>
        <div class="flex gap-1">
            <a href="dashboard.html" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> <span class="hide-mobile">Back to Dashboard</span>
            </a>
            <div class="search-container" style="position: relative;">
                <input type="text" class="form-input" placeholder="Search policies..." id="searchInput" style="padding-right: 40px; width: 250px;">
                <i class="fas fa-search" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: var(--uvms-text-secondary-light);"></i>
            </div>
        </div>
    </div>

    <div class="alert alert-info mb-3">
        <i class="fas fa-info-circle"></i> Please review all policies and guidelines carefully to ensure compliance with UDOM requirements.
    </div>

    <div class="grid grid-4 gap-3">
        <!-- Categories -->
        <div class="grid-span-1">
            <div class="card">
                <div class="card-body">
                    <h4 style="margin-bottom: 15px; color: var(--uvms-blue-primary);">Categories</h4>
                    <div class="nav-tabs-vertical" id="categoriesContainer">
                        <!-- Filled dynamically -->
                    </div>

                    <hr style="margin: 20px 0;">
                    <h5 style="margin-bottom: 15px; color: var(--uvms-blue-primary);">Important Updates</h5>
                    <div id="importantUpdates"></div>
                </div>
            </div>
        </div>

        <!-- Policies -->
        <div class="grid-span-3">
            <div class="tab-content">
                <div class="tab-panel active" id="policiesContainer">
                    <!-- Filled dynamically -->
                </div>
            </div>
        </div>
    </div>
</div>
<script src="js/uvms-main.js"></script>

<script>
    const apiBase = "https://uvmsapiv1.onrender.com/api";
    const token = localStorage.getItem("jwtToken");

    // Fetch user info
    async function loadUser() {
        try {
            const res = await fetch(`${apiBase}/vendors/dashboard`, {
                headers: { "Authorization": "Bearer " + token }
            });
            if (!res.ok) throw new Error("Failed to fetch user");
            const user = await res.json();
            const fullName = user.firstName + " " + user.lastName;
            document.getElementById("userName").textContent = fullName;
            document.getElementById("userAvatar").textContent =
                (user.firstName[0] + user.lastName[0]).toUpperCase();
        } catch (err) {
            console.error(err);
        }
    }

    // Fetch policies
    async function loadPolicies() {
        try {
            const res = await fetch(`${apiBase}/policies`);
            if (!res.ok) throw new Error("Failed to fetch policies");
            const policies = await res.json();

            // Sort by date (latest first)
            policies.sort((a, b) => new Date(b.datePosted) - new Date(a.datePosted));

            // Categories (unique by title for left nav)
            const categoriesContainer = document.getElementById("categoriesContainer");
            categoriesContainer.innerHTML = "";
            policies.forEach((p, idx) => {
                const a = document.createElement("a");
                a.href = "#";
                a.className = "nav-tab" + (idx === 0 ? " active" : "");
                a.dataset.tab = "policy-" + p.policy_id;
                a.innerHTML = `<i class="fas fa-file-alt"></i> ${p.title}`;
                categoriesContainer.appendChild(a);
            });

            // Policies display
            const policiesContainer = document.getElementById("policiesContainer");
            policiesContainer.innerHTML = "";
            policies.forEach((p, idx) => {
                const div = document.createElement("div");
                div.className = "card policy-card tab-panel" + (idx === 0 ? " active" : "");
                div.id = "tab-policy-" + p.policy_id;
                div.innerHTML = `
            <div class="card-body">
              <h4 style="margin-bottom: 10px; color: var(--uvms-blue-primary);">${p.title}</h4>
              <p style="margin: 10px 0; color: var(--uvms-text-secondary-light);">${p.content}</p>
              <small style="color: var(--uvms-text-secondary-light);">Posted: ${new Date(p.datePosted).toLocaleDateString()}</small>
            </div>`;
                policiesContainer.appendChild(div);
            });

            // Important Updates (last 2)
            const updatesContainer = document.getElementById("importantUpdates");
            updatesContainer.innerHTML = "";
            policies.slice(0, 2).forEach(p => {
                const alert = document.createElement("div");
                alert.className = "alert alert-warning mb-2";
                alert.style = "padding: 10px; font-size: 0.85em;";
                alert.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${p.title}`;
                updatesContainer.appendChild(alert);
            });

            // Tabs click handler
            document.querySelectorAll(".nav-tab").forEach(tab => {
                tab.addEventListener("click", e => {
                    e.preventDefault();
                    document.querySelectorAll(".nav-tab").forEach(t => t.classList.remove("active"));
                    document.querySelectorAll(".policy-card").forEach(panel => panel.style.display = "none");
                    tab.classList.add("active");
                    const target = document.getElementById("tab-" + tab.dataset.tab);
                    if (target) target.style.display = "block";
                });
            });

        } catch (err) {
            console.error(err);
        }
    }

    // Search filter
    document.getElementById("searchInput").addEventListener("keyup", function() {
        const searchText = this.value.toLowerCase();
        document.querySelectorAll(".policy-card").forEach(card => {
            const text = card.textContent.toLowerCase();
            card.style.display = text.includes(searchText) ? "block" : "none";
        });
    });

    // Init
    loadUser();
    loadPolicies();
</script>
</body>
</html>
