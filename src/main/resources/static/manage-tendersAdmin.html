<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UVMS - Manage Tenders</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/admin.css">
</head>
<body>
<!-- Header -->
<header>
    <div class="header-left">
        <div class="menu-toggle"><i class="fas fa-bars"></i></div>
        <div class="logo">UDOM Vendor Management System</div>
    </div>
    <div class="header-right">
        <div class="logout-btn"><i class="fas fa-sign-out-alt"></i></div>
    </div>
</header>

<!-- Sidebar -->
<div class="sidebar">
    <div class="sidebar-header">Admin Portal</div>
    <div class="sidebar-scroll-container">
        <ul class="sidebar-menu">
            <li><a href="Admindashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
            <li><a href="manage-tendersAdmin.html"><i class="fas fa-list"></i> Manage Tenders</a></li>
            <li><a href="#"><i class="fas fa-map-marker-alt"></i> Manage Plots</a></li>
            <li><a href="applicationsAdmin.html" class="active"><i class="fas fa-file-alt"></i> Applications</a></li>
            <li><a href="#"><i class="fas fa-clipboard-check"></i> Application Review</a></li>
            <li><a href="#"><i class="fas fa-certificate"></i> Licenses</a></li>
            <li><a href="licensesAdimin.html"><i class="fas fa-sync-alt"></i> License Renewals</a></li>
            <li><a href="#"><i class="fas fa-book"></i> Policies</a></li>
            <li><a href="#"><i class="fas fa-bell"></i> Notifications</a></li>
            <li><a href="#"><i class="fas fa-key"></i> Change Password</a></li>
        </ul>
    </div>
</div>

<!-- Main Content -->
<div class="main-content">
    <div class="content-section">
        <div class="content-header">
            <h2>Manage Tenders</h2>
            <p id="adminName">Loading...</p>
            <button class="btn btn-primary" id="add-tender-btn">Add New Tender</button>
        </div>

        <div class="search-filter">
            <input type="text" placeholder="Search tenders..." class="search-input" id="searchTender">
            <select class="filter-select" id="filterTender">
                <option value="all">All Tenders</option>
                <option value="ACTIVE">Active</option>
                <option value="UPCOMING">Upcoming</option>
                <option value="CLOSED">Closed</option>
            </select>
        </div>

        <table>
            <thead>
            <tr>
                <th>Tender ID</th>
                <th>Title</th>
                <th>Description</th>
                <th>Plots</th>
                <th>Status</th>
                <th>Created</th>
                <th>Updated</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody id="tendersTable"></tbody>
        </table>
    </div>
</div>

<!-- Add Tender Modal -->
<div id="tender-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add New Tender</h3>
            <span class="close-modal">&times;</span>
        </div>
        <form id="tender-form">
            <div class="form-group">
                <label for="tender-title">Tender Title</label>
                <input type="text" id="tender-title" required>
            </div>
            <div class="form-group">
                <label for="tender-description">Description</label>
                <textarea id="tender-description" rows="4" required></textarea>
            </div>
            <div class="form-group">
                <label for="deadline-date">Deadline Date</label>
                <input type="date" id="deadline-date" required>
            </div>
            <div class="form-group">
                <label for="tender-status">Status</label>
                <select id="tender-status" required>
                    <option value="ACTIVE">Active</option>
                    <option value="UPCOMING">Upcoming</option>
                    <option value="CLOSED">Closed</option>
                </select>
            </div>
            <div class="form-group">
                <label for="tender-college">College</label>
                <select id="tender-college" required>
                    <option value="">Select College</option>
                </select>
            </div>

            <button type="submit" class="btn btn-primary">Create Tender</button>
        </form>
    </div>
</div>

<script>
    const apiBase = "https://uvmsapiv1.onrender.com/api";
    const token = localStorage.getItem("jwtToken");
    const authHeaders = { "Authorization": "Bearer " + token, "Content-Type": "application/json" };

    let adminData = {};
    let tenders = [];
    let colleges = [];

    // Load Admin Name
    fetch(`${apiBase}/vendors/dashboard`, { headers: authHeaders })
        .then(res => res.json())
        .then(data => {
            adminData = data;
            document.getElementById("adminName").innerText = `${data.firstName} ${data.lastName}`;
        });

    // Load Colleges for Dropdown
    function loadColleges() {
        fetch(`${apiBase}/colleges`, { headers: authHeaders })
            .then(res => res.json())
            .then(data => {
                colleges = data;
                const collegeSelect = document.getElementById("tender-college");
                collegeSelect.innerHTML = `<option value="">Select College</option>`;
                data.forEach(c => {
                    collegeSelect.innerHTML += `<option value="${c.college_id}">${c.college_name}</option>`;
                });
            });
    }

    // Load Tenders
    function loadTenders() {
        fetch(`${apiBase}/tenders`, { headers: authHeaders })
            .then(res => res.json())
            .then(data => {
                tenders = data;
                renderTenders(data);
            });
    }

    function renderTenders(list) {
        const tbody = document.getElementById("tendersTable");
        tbody.innerHTML = "";
        list.forEach(t => {
            tbody.innerHTML += `
          <tr>
            <td>${t.tender_id}</td>
            <td>${t.title}</td>
            <td>${t.description}</td>
            <td>${t.plots.join(", ")}</td>
            <td><span class="status-badge status-${t.status.toLowerCase()}">${t.status}</span></td>
            <td>${new Date(t.createdAt).toLocaleDateString()}</td>
            <td>${new Date(t.updatedAt).toLocaleDateString()}</td>
            <td>
              <button class="btn-icon delete-btn" onclick="deleteTender(${t.tender_id})">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        `;
        });
    }

    // Delete Tender
    function deleteTender(id) {
        if (confirm("Are you sure you want to delete this tender?")) {
            fetch(`${apiBase}/tenders/${id}`, {
                method: "DELETE",
                headers: authHeaders
            }).then(() => {
                alert("Tender deleted");
                loadTenders();
            });
        }
    }

    // Modal Handlers
    const modal = document.getElementById("tender-modal");
    const addBtn = document.getElementById("add-tender-btn");
    const closeBtn = document.querySelector(".close-modal");

    addBtn.onclick = () => modal.style.display = "flex";
    closeBtn.onclick = () => modal.style.display = "none";
    window.onclick = e => { if (e.target === modal) modal.style.display = "none"; };

    // Create Tender (POST)
    document.getElementById("tender-form").addEventListener("submit", e => {
        e.preventDefault();

        const payload = {
            college: parseInt(document.getElementById("tender-college").value),
            title: document.getElementById("tender-title").value,
            description: document.getElementById("tender-description").value,
            deadlineDate: new Date(document.getElementById("deadline-date").value).toISOString(),
            status: document.getElementById("tender-status").value,
            contractTemplatePath: "/contracts/sample_contract.pdf", // static or auto
            createdBy: {
                admin_id: 1
            }
        };

        fetch(`${apiBase}/tenders`, {
            method: "POST",
            headers: authHeaders,
            body: JSON.stringify(payload)
        }).then(res => {
            if (res.ok) {
                alert("Tender created successfully");
                modal.style.display = "none";
                loadTenders();
            } else {
                alert("Error creating tender");
            }
        });
    });

    // Initial Load
    loadTenders();
    loadColleges();
</script>

</body>
</html>
<script>
    const apiBase = "https://uvmsapiv1.onrender.com/api";
    const token = localStorage.getItem("jwtToken");
    const authHeaders = {
        "Authorization": "Bearer " + token,
        "Content-Type": "application/json"
    };

    let adminData = {};
    let tenders = [];
    let colleges = [];

    // ==========================
    // Load Admin Info
    // ==========================
    fetch(`${apiBase}/vendors/dashboard`, { headers: authHeaders })
        .then(res => res.json())
        .then(data => {
            adminData = data;
            document.getElementById("adminName").innerText =
                `${data.firstName} ${data.lastName}`;
        });

    // ==========================
    // Load Colleges into Dropdown
    // ==========================
    function loadColleges() {
        fetch(`${apiBase}/colleges`, { headers: authHeaders })
            .then(res => res.json())
            .then(data => {
                colleges = data;
                const select = document.getElementById("tender-college");
                select.innerHTML = "";
                data.forEach(c => {
                    const opt = document.createElement("option");
                    opt.value = c.college_id;
                    opt.textContent = c.college_name;
                    select.appendChild(opt);
                });
            });
    }

    // ==========================
    // Load Tenders
    // ==========================
    function loadTenders() {
        fetch(`${apiBase}/tenders`, { headers: authHeaders })
            .then(res => res.json())
            .then(data => {
                tenders = data;
                renderTenders(data);
            });
    }

    // ==========================
    // Render Tenders
    // ==========================
    function renderTenders(list) {
        const tbody = document.getElementById("tendersTable");
        tbody.innerHTML = "";
        list.forEach(t => {
            tbody.innerHTML += `
              <tr>
                <td>${t.tender_id}</td>
                <td>${t.title}</td>
                <td>${t.description}</td>
                <td>${t.plots ? t.plots.join(", ") : "-"}</td>
                <td><span class="status-badge status-${t.status.toLowerCase()}">${t.status}</span></td>
                <td>${new Date(t.createdAt).toLocaleDateString()}</td>
                <td>${new Date(t.updatedAt).toLocaleDateString()}</td>
                <td>
                  <button class="btn-icon delete-btn" onclick="deleteTender(${t.tender_id})">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>
            `;
        });
    }

    // ==========================
    // Delete Tender
    // ==========================
    function deleteTender(id) {
        if (confirm("Are you sure you want to delete this tender?")) {
            fetch(`${apiBase}/tenders/${id}`, {
                method: "DELETE",
                headers: authHeaders
            }).then(() => {
                alert("Tender deleted");
                loadTenders();
            });
        }
    }

    // ==========================
    // Modal Handlers
    // ==========================
    const modal = document.getElementById("tender-modal");
    const addBtn = document.getElementById("add-tender-btn");
    const closeBtn = document.querySelector(".close-modal");

    addBtn.onclick = () => modal.style.display = "flex";
    closeBtn.onclick = () => modal.style.display = "none";
    window.onclick = e => {
        if (e.target === modal) modal.style.display = "none";
    };

    // ==========================
    // Create Tender (POST)
    // ==========================
    document.getElementById("tender-form").addEventListener("submit", e => {
        e.preventDefault();

        const payload = {
            college: { college_id: parseInt(document.getElementById("tender-college").value) },
            title: document.getElementById("tender-title").value,
            description: document.getElementById("tender-description").value,
            deadlineDate: new Date(document.getElementById("deadline-date").value).toISOString(),
            status: document.getElementById("tender-status").value,
            contractTemplatePath: document.getElementById("contract-path").value,
            createdBy: { admin_id: 1 } // TODO: replace with logged-in admin
        };

        console.log("Submitting payload:", payload);

        fetch(`${apiBase}/tenders`, {
            method: "POST",
            headers: authHeaders,
            body: JSON.stringify(payload)
        }).then(res => {
            if (res.ok) {
                alert("Tender created successfully");
                modal.style.display = "none";
                loadTenders();
            } else {
                res.text().then(msg => alert("Error creating tender: " + msg));
            }
        });
    });

    // ==========================
    // Initial Load
    // ==========================
    loadColleges();
    loadTenders();
</script>


