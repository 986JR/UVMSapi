<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UVMS - University of Dodoma Vendor Management System</title>
    <link rel="stylesheet" href="css/styleIndex.css">
</head>
<body>
<!-- Header -->
<header class="header">
    <div class="container">
        <div class="logo">
            <div class="logo-icon">UVMS</div>
            <span class="logo-text">UDOM VENDOR MANAGEMENT SYSTEM</span>
        </div>
        <nav class="nav">
            <a href="#" class="nav-link">Home</a>
            <a href="register.html" class="nav-link">Register</a>
            <a href="forgotPassword.html" class="nav-link">Forgot Password</a>
        </nav>
    </div>
</header>

<!-- Main Content -->
<main class="main">
    <div class="container">
        <!-- Hero Section -->
        <section class="hero">
            <h1 class="hero-title">Official Vendor Management System for The University of Dodoma</h1>
            <p class="hero-subtitle">
                Ensuring accountability, transparency and efficiency in all vendor and tender processes.
            </p>
            <hr id="hero-line">
        </section>

        <!-- Active Tenders & Login -->
        <section class="tenders-section">
            <div class="active-section">
                <h2 class="section-title">Active Tenders <span id="total-tender-count">(Loading...)</span></h2>
                <hr id="active-line">

                <!-- Login Form -->
                <form id="loginForm">
                    <div class="email-section">
                        <input type="email" placeholder="Email" id="email" name="email" required>
                        <input type="password" placeholder="Password" id="password" name="password" required>
                        <button type="submit" class="login-btn">Login</button>
                    </div>
                </form>
            </div>

            <!-- Dynamic Filter Categories -->
            <div class="filters" id="college-filters">
                <div class="loading">Loading colleges, tenders and policies...</div>
            </div>
        </section>
    </div>
</main>

<!-- Footer -->
<footer>
    <div class="container">
        <p>For Support: Call/Whatsapp <strong>+255712000000</strong> <br>
            Email: Administration@uvms.com <br>
            &copy; 2025 UDOM Vendor Management System. All rights reserved.</p>
    </div>
</footer>

<!-- JS -->
<script src="js/login.js"></script>
<script>
    const API_BASE_URL = 'https://uvmsapiv1.onrender.com/api';
    let collegesData = [];
    let policiesData = [];
    const collegeFilters = document.getElementById('college-filters');
    const totalTenderCount = document.getElementById('total-tender-count');

    document.addEventListener('DOMContentLoaded', () => initializeApp());

    async function initializeApp() {
        try {
            const [collegesRes, tendersRes] = await Promise.all([
                fetch(`${API_BASE_URL}/colleges`, { headers: { 'Accept': 'application/json' } }),
                fetch(`${API_BASE_URL}/tenders`, { headers: { 'Accept': 'application/json' } })
            ]);

            if (!collegesRes.ok) throw new Error(`Colleges fetch error: ${collegesRes.status}`);
            if (!tendersRes.ok) throw new Error(`Tenders fetch error: ${tendersRes.status}`);

            const colleges = await collegesRes.json();
            const tenders = await tendersRes.json();

            // Map tenders by college
            const tendersByCollege = {};
            tenders.forEach(t => {
                if (!tendersByCollege[t.college]) tendersByCollege[t.college] = [];
                tendersByCollege[t.college].push(t);
            });

            // Combine colleges + tenders
            collegesData = colleges.map(c => ({
                ...c,
                tenders: tendersByCollege[c.college_id] || []
            }));

            await fetchPolicies();
            renderCollegesWithTenders();

        } catch (error) {
            console.error("Initialization error:", error);
            showError("Failed to load data. Please refresh.");
        }
    }

    // Fetch active policies
    async function fetchPolicies() {
        try {
            const res = await fetch(`${API_BASE_URL}/policies/active`, { headers: { 'Accept': 'application/json' } });
            if (!res.ok) throw new Error(`Policies fetch error: ${res.status}`);
            policiesData = await res.json();
        } catch (err) {
            console.error("Error fetching policies:", err);
            policiesData = [];
        }
    }

    // Render colleges & tenders + policies
    function renderCollegesWithTenders() {
        collegeFilters.innerHTML = "";
        let totalActiveTenders = 0;

        collegesData.forEach(college => {
            const activeTenders = (college.tenders || []).filter(t => t.status === "ACTIVE");
            totalActiveTenders += activeTenders.length;

            const div = document.createElement("div");
            div.className = "filter-column";
            div.innerHTML = `
            <h3 class="filter-title">
                ${college.college_name}
                <span class="tender-count">${activeTenders.length}</span>
            </h3>
            <ul class="filter-list">
                ${activeTenders.length > 0
                ? activeTenders.slice(-3).reverse().map(t => `
                        <li>
                            <a href="#" class="filter-link" onclick="viewTenderDetails(${t.tender_id})">
                                <strong>${t.title}</strong><br>
                                <small style="color:#7f8c8d;">Deadline: ${t.deadlineDate ? new Date(t.deadlineDate).toLocaleDateString() : "N/A"}</small>
                            </a>
                        </li>
                    `).join("")
                : `<li><span style="color:#95a5a6;">No active tenders</span></li>`
            }
            </ul>
        `;
            collegeFilters.appendChild(div);
        });

        // Render policies
        if (policiesData.length > 0) collegeFilters.appendChild(createPoliciesDiv());

        totalTenderCount.textContent = `(${totalActiveTenders})`;
    }

    function createPoliciesDiv() {
        const div = document.createElement("div");
        div.className = "filter-column";
        div.innerHTML = `
        <h3 class="filter-title">Policies and Guidelines</h3>
        <ul class="filter-list">
            ${policiesData.length > 0
            ? policiesData.map(p => `
                    <li>
                        <a href="#" class="filter-link" onclick="viewPolicyDetails(${p.policy_id})">${p.title}</a>
                    </li>`).join("")
            : `<li><span style="color:#95a5a6;">No active policies</span></li>`
        }
        </ul>
    `;
        return div;
    }

    function viewTenderDetails(tenderId) {
        let found = null;
        for (const c of collegesData) {
            found = (c.tenders || []).find(t => t.tender_id === tenderId);
            if (found) break;
        }
        if (found) {
            alert(`Tender Details:\n\nTitle: ${found.title}\nDescription: ${found.description}\nStatus: ${found.status}\nDeadline: ${found.deadlineDate}`);
        }
    }

    function viewPolicyDetails(policyId) {
        const policy = policiesData.find(p => p.policy_id === policyId);
        if (policy) {
            alert(`Policy Details:\n\nTitle: ${policy.title}\nScope: ${policy.scope}\n\n${policy.content}`);
        }
    }

    function showError(msg) {
        collegeFilters.innerHTML = `<div class="error">${msg}</div>`;
    }

    // Refresh every 5 minutes
    setInterval(initializeApp, 5 * 60 * 1000);
</script>
</body>
</html>
