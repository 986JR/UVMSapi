<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Applications | UDOM Vendor Management System</title>
    <link rel="stylesheet" href="css/vendor-styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Keep your existing CSS from Applications Query file */
    </style>
</head>
<body>
<!-- Mobile Menu Toggle -->
<button class="mobile-menu-toggle" id="mobileMenuToggle">
    <i class="fas fa-bars"></i>
</button>

<!-- Sidebar -->
<div class="sidebar">
    <div class="sidebar-header"><h3>UVMS</h3></div>
    <nav class="sidebar-nav">
        <a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
        <a href="colleges.html"><i class="fas fa-university"></i> Tenders</a>
        <a href="applications.html" class="active"><i class="fas fa-clipboard-list"></i> Applications</a>
        <a href="licenses.html"><i class="fas fa-certificate"></i> Licenses</a>
        <a href="#"><i class="fas fa-file-signature"></i> Contracts</a>
        <a href="policies.html"><i class="fas fa-book"></i> Policies</a>
        <a href="#"><i class="fas fa-bell"></i> Notifications</a>
        <a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </nav>
</div>

<!-- Navbar -->
<nav class="navbar">
    <div class="navbar-brand">My Applications</div>
    <div class="navbar-user">
        <div class="user-avatar" id="userInitials">JD</div>
        <span id="userFullName">John Doe</span>
    </div>
</nav>

<!-- Main Content -->
<div class="main-content">
    <!-- Search & Filter -->
    <div class="card mb-3">
        <div class="card-body">
            <div class="flex flex-between align-center gap-2 flex-mobile-stack">
                <a href="college-tenders.html" class="btn btn-primary">
                    <i class="fas fa-plus"></i> <span class="hide-mobile">Browse Tenders</span>
                </a>
                <div class="flex gap-1 gap-mobile-1">
                    <button class="btn sort btn-secondary" onclick="filterApplications('all')"><i class="fas fa-list"></i> All</button>
                    <button class="btn sort btn-secondary" onclick="filterApplications('PENDING')"><i class="fas fa-clock"></i> Pending</button>
                    <button class="btn sort btn-secondary" onclick="filterApplications('APPROVED')"><i class="fas fa-check"></i> Approved</button>
                    <button class="btn sort btn-secondary" onclick="filterApplications('DENIED')"><i class="fas fa-times"></i> Denied</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Summary -->
    <div class="stats-grid mb-3" id="statsContainer" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
        <!-- Stats will be injected dynamically -->
    </div>

    <!-- Applications Container -->
    <div class="grid grid-1" id="applicationsContainer"></div>
</div>

<!-- Application Details Modal -->
<div id="applicationModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Application Details</h2>
            <button class="close-modal" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <!-- Application info will be populated dynamically -->
            <div class="modal-section">
                <h3>Application Information</h3>
                <div class="info-grid">
                    <div class="info-item"><span class="info-label">Application ID</span><span class="info-value" id="modal-app-id">-</span></div>
                    <div class="info-item"><span class="info-label">Status</span><span class="info-value" id="modal-status">-</span></div>
                    <div class="info-item"><span class="info-label">Application Date</span><span class="info-value" id="modal-app-date">-</span></div>
                    <div class="info-item"><span class="info-label">Submitted Contract</span><a href="#" class="file-download" id="modal-submitted-contract"><i class="fas fa-file-pdf"></i> Download</a></div>
                    <div class="info-item" id="approved-contract-section" style="display:none;">
                        <span class="info-label">Approved Contract</span>
                        <a href="#" class="file-download" id="modal-approved-contract"><i class="fas fa-file-contract"></i> Download</a>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
            <button class="btn btn-primary" id="modal-download-btn" style="display:none;" onclick="downloadCurrentContract()">
                <i class="fas fa-download"></i> Download Contract
            </button>
        </div>
    </div>
</div>

<script>
    const apiBase = "https://uvmsapiv1.onrender.com/api";
    const token = localStorage.getItem("jwtToken");

    if (!token) {
        alert("Session expired. Please log in again.");
        window.location.href = "login.html";
    }

    const authHeaders = {
        "Authorization": "Bearer " + token,
        "Content-Type": "application/json"
    };

    let vendorId = null;

    // Load vendor details (for navbar)
    async function loadVendor() {
        try {
            const res = await fetch(`${apiBase}/vendors/dashboard`, { headers: authHeaders });

            if (res.status === 401 || res.status === 403) {
                alert("Session expired. Please log in again.");
                window.location.href = "login.html";
                return;
            }

            if (!res.ok) throw new Error("Failed to load vendor");

            const vendor = await res.json();
            vendorId = vendor.vendorId;

            document.querySelector(".navbar-user span").textContent = vendor.fullName;
            const initials = (vendor.firstName[0] + vendor.lastName[0]).toUpperCase();
            document.querySelector(".user-avatar").textContent = initials;

        } catch (err) {
            console.error("Vendor load error:", err);
        }
    }

    // Load applications and filter by vendor
    async function loadApplications() {
        try {
            const res = await fetch(`${apiBase}/applications`, { headers: authHeaders });

            if (!res.ok) throw new Error("Failed to fetch applications");

            const allApps = await res.json();
            const apps = allApps.filter(app => app.vendor === vendorId);

            renderStats(apps);
            renderApplications(apps);

        } catch (err) {
            console.error("Applications load error:", err);
        }
    }

    // Render stats summary
    function renderStats(apps) {
        const total = apps.length;
        const pending = apps.filter(a => a.status === "PENDING").length;
        const approved = apps.filter(a => a.status === "APPROVED").length;
        const denied = apps.filter(a => a.status === "DENIED").length;

        const statsGrid = document.querySelector(".stats-grid");
        statsGrid.innerHTML = `
        <div class="card"><div class="card-body"><h2>${total}</h2><p>Total Applications</p></div></div>
        <div class="card"><div class="card-body"><h2>${pending}</h2><p>Pending</p></div></div>
        <div class="card"><div class="card-body"><h2>${approved}</h2><p>Approved</p></div></div>
        <div class="card"><div class="card-body"><h2>${denied}</h2><p>Denied</p></div></div>
    `;
    }

    // Render applications list
    function renderApplications(apps) {
        const container = document.getElementById("applicationsContainer");
        container.innerHTML = "";

        if (apps.length === 0) {
            container.innerHTML = `<p style="color:var(--uvms-text-secondary-light);">No applications found</p>`;
            return;
        }

        apps.forEach(app => {
            const badgeClasses = {
                PENDING: "badge-warning",
                APPROVED: "badge-success",
                DENIED: "badge-error"
            };

            const card = document.createElement("div");
            card.className = "card application-card";
            card.dataset.status = app.status.toLowerCase();

            card.innerHTML = `
            <div class="card-body">
                <div class="flex flex-between align-center mb-2 flex-mobile-stack">
                    <div>
                        <h4 style="margin:0;color:var(--uvms-blue-primary);">Application #${app.application_id}</h4>
                        <p style="margin:5px 0;color:var(--uvms-text-secondary-light);font-size:0.9em;">
                            <strong>Plot:</strong> ${app.plot} | <strong>License:</strong> ${app.license || "N/A"}
                        </p>
                    </div>
                    <span class="badge ${badgeClasses[app.status]}">${app.status}</span>
                </div>

                <div class="grid grid-4 gap-2 mb-3" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                    <div><small style="color: var(--uvms-text-secondary-light);">Application Date:</small>
                        <p style="margin:0;font-weight:500;">${new Date(app.applicationDate).toLocaleDateString()}</p>
                    </div>
                    <div><small style="color: var(--uvms-text-secondary-light);">Application ID:</small>
                        <p style="margin:0;font-weight:500;">${app.application_id}</p>
                    </div>
                    <div><small style="color: var(--uvms-text-secondary-light);">Contract:</small>
                        <p style="margin:0;font-weight:500;">
                            ${app.submittedContractPath ? `<a href="${app.submittedContractPath}" target="_blank" style="color: var(--uvms-blue-primary);"><i class="fas fa-file-pdf"></i> ${app.submittedContractPath.split('/').pop()}</a>` : "N/A"}
                        </p>
                    </div>
                    <div><small style="color: var(--uvms-text-secondary-light);">Status:</small>
                        <p style="margin:0;font-weight:500;">${app.status}</p>
                    </div>
                </div>

                <div class="flex flex-between align-center">
                    <small style="color: var(--uvms-text-secondary-light);"><i class="fas fa-clock"></i> Submitted</small>
                    <div class="flex gap-1">
                        <button class="btn btn-sm btn-secondary" onclick="showApplicationDetails(${app.application_id})"><i class="fas fa-eye"></i> View Details</button>
                        ${app.status === "PENDING" ? '<button class="btn btn-sm btn-outline-danger"><i class="fas fa-times"></i> Withdraw</button>' : ""}
                        ${app.status === "APPROVED" ? `<button class="btn btn-sm btn-success"><i class="fas fa-download"></i> Download Contract</button>` : ""}
                    </div>
                </div>
            </div>
        `;

            container.appendChild(card);
        });
    }

    // Init function
    async function init() {
        await loadVendor();
        if (vendorId) {
            await loadApplications();
        }
    }

    init();
</script>

</body>
</html>
