<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Applications | UDOM Vendor Management System</title>
    <link rel="stylesheet" href="css/vendor-styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <h2>UVMS</h2>
        <button class="close-btn" id="closeSidebar"><i class="fas fa-times"></i></button>
    </div>
    <nav class="sidebar-nav">
        <ul>
            <li><a href="vendor-dashboard.html"><i class="fas fa-home"></i> Dashboard</a></li>
            <li><a href="tenders.html"><i class="fas fa-file-contract"></i> Tenders</a></li>
            <li><a href="applications.html" class="active"><i class="fas fa-tasks"></i> My Applications</a></li>
            <li><a href="contracts.html"><i class="fas fa-scroll"></i> Contracts</a></li>
            <li><a href="notifications.html"><i class="fas fa-bell"></i> Notifications</a></li>
            <li><a href="profile.html"><i class="fas fa-user"></i> Profile</a></li>
        </ul>
    </nav>
</aside>

<!-- Main Content -->
<main class="main-content">
    <!-- Navbar -->
    <header class="navbar">
        <button class="menu-btn" id="openSidebar"><i class="fas fa-bars"></i></button>
        <h1>My Applications</h1>
        <div class="nav-actions">
            <button class="btn btn-sm btn-outline"><i class="fas fa-bell"></i></button>
            <button class="btn btn-sm btn-outline"><i class="fas fa-user"></i></button>
        </div>
    </header>

    <!-- Page Content -->
    <div class="page-content">
        <!-- Stats Summary -->
        <div class="grid grid-4 gap-2 mb-3">
            <div class="card card-stats">
                <div class="card-body">
                    <h3 id="totalCount">0</h3>
                    <p>Total Applications</p>
                </div>
            </div>
            <div class="card card-stats">
                <div class="card-body">
                    <h3 id="pendingCount">0</h3>
                    <p>Pending</p>
                </div>
            </div>
            <div class="card card-stats">
                <div class="card-body">
                    <h3 id="approvedCount">0</h3>
                    <p>Approved</p>
                </div>
            </div>
            <div class="card card-stats">
                <div class="card-body">
                    <h3 id="deniedCount">0</h3>
                    <p>Denied</p>
                </div>
            </div>
        </div>

        <!-- Applications Header -->
        <div class="flex flex-between align-center mb-2">
            <h2>Applications List</h2>
            <div class="flex gap-1">
                <button class="btn btn-sm btn-outline" onclick="filterApplications('all')">All</button>
                <button class="btn btn-sm btn-outline" onclick="filterApplications('pending')">Pending</button>
                <button class="btn btn-sm btn-outline" onclick="filterApplications('approved')">Approved</button>
                <button class="btn btn-sm btn-outline" onclick="filterApplications('denied')">Denied</button>
            </div>
        </div>

        <!-- Applications List -->
        <div class="grid grid-1" id="applicationsContainer">
            <p style="text-align:center; color: var(--uvms-text-secondary-light);">Loading applications...</p>
        </div>
    </div>
</main>

<!-- Scripts -->
<script>
    const apiBase = "https://uvmsapiv1.onrender.com/api";
    const token = localStorage.getItem("jwtToken");

    const authHeaders = {
        "Authorization": "Bearer " + token,
        "Content-Type": "application/json"
    };

    // Sidebar toggle
    const sidebar = document.getElementById("sidebar");
    document.getElementById("openSidebar").addEventListener("click", () => {
        sidebar.classList.add("active");
    });
    document.getElementById("closeSidebar").addEventListener("click", () => {
        sidebar.classList.remove("active");
    });

    async function fetchApplications() {
        const container = document.getElementById("applicationsContainer");
        container.innerHTML = `<p style="text-align:center; color: var(--uvms-text-secondary-light);">Loading applications...</p>`;

        try {
            const response = await fetch(`${apiBase}/applications`, { headers: authHeaders });

            if (!response.ok) {
                throw new Error(`Server responded with status: ${response.status}`);
            }

            const data = await response.json();

            if (!Array.isArray(data) || data.length === 0) {
                container.innerHTML = `<p style="text-align:center; color: gray;">No applications found.</p>`;
                updateStats([]);
                return;
            }

            updateStats(data);
            renderApplications(data);

        } catch (error) {
            console.error("Error fetching applications:", error);
            container.innerHTML = `
                <div style="text-align:center; padding:20px; color:red;">
                    <i class="fas fa-exclamation-circle"></i>
                    Failed to load applications. Please try again later.
                </div>
            `;
            updateStats([]);
        }
    }

    function renderApplications(data) {
        const container = document.getElementById("applicationsContainer");
        container.innerHTML = "";

        data.forEach(app => {
            const statusClass = app.status === "pending"
                ? "badge-warning"
                : app.status === "approved"
                    ? "badge-success"
                    : "badge-error";

            const statusLabel = app.status.charAt(0).toUpperCase() + app.status.slice(1);

            const card = `
                <div class="card application-card" data-status="${app.status}">
                    <div class="card-body">
                        <div class="flex flex-between align-center mb-2 flex-mobile-stack">
                            <div>
                                <h4 style="margin: 0; color: var(--uvms-blue-primary);">${app.tenderTitle}</h4>
                                <p style="margin: 5px 0; color: var(--uvms-text-secondary-light); font-size: 0.9em;">
                                    <strong>Plot:</strong> ${app.plot} | <strong>College:</strong> ${app.college.college_name}
                                </p>
                            </div>
                            <span class="badge ${statusClass}">${statusLabel}</span>
                        </div>

                        <div class="grid grid-4 gap-2 mb-3" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                            <div>
                                <small style="color: var(--uvms-text-secondary-light);">Application Date:</small>
                                <p style="margin: 0; font-weight: 500;">${app.applicationDate || "-"}</p>
                            </div>
                            <div>
                                <small style="color: var(--uvms-text-secondary-light);">Application ID:</small>
                                <p style="margin: 0; font-weight: 500;">${app.applicationId || "-"}</p>
                            </div>
                            <div>
                                <small style="color: var(--uvms-text-secondary-light);">Submitted Contract:</small>
                                <p style="margin: 0; font-weight: 500;">
                                    <a href="${app.submittedContract || '#'}" style="color: var(--uvms-blue-primary);">
                                        <i class="fas fa-file-pdf"></i> ${app.submittedContract ? "contract.pdf" : "N/A"}
                                    </a>
                                </p>
                            </div>
                            <div>
                                <small style="color: var(--uvms-text-secondary-light);">Status:</small>
                                <p style="margin: 0; font-weight: 500;">${statusLabel}</p>
                            </div>
                        </div>

                        <div class="flex flex-between align-center">
                            <small style="color: var(--uvms-text-secondary-light);">
                                <i class="fas fa-clock"></i> Submitted ${app.submittedAgo || "N/A"}
                            </small>
                            <div class="flex gap-1">
                                <button class="btn btn-sm btn-secondary" onclick="showApplicationDetails('${app.applicationId}', '${app.status}')">
                                    <i class="fas fa-eye"></i> View Details
                                </button>
                                ${app.status === "pending" ? `
                                    <button class="btn btn-sm btn-outline-danger">
                                        <i class="fas fa-times"></i> Withdraw
                                    </button>` : ""}
                                ${app.status === "approved" ? `
                                    <button class="btn btn-sm btn-success" onclick="downloadContract('${app.applicationId}')">
                                        <i class="fas fa-download"></i> Download Contract
                                    </button>` : ""}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML += card;
        });
    }

    function updateStats(data) {
        const total = data.length;
        const pending = data.filter(app => app.status === "pending").length;
        const approved = data.filter(app => app.status === "approved").length;
        const denied = data.filter(app => app.status === "denied").length;

        document.getElementById("totalCount").textContent = total;
        document.getElementById("pendingCount").textContent = pending;
        document.getElementById("approvedCount").textContent = approved;
        document.getElementById("deniedCount").textContent = denied;
    }

    function filterApplications(status) {
        const cards = document.querySelectorAll(".application-card");
        cards.forEach(card => {
            if (status === "all" || card.dataset.status === status) {
                card.style.display = "block";
            } else {
                card.style.display = "none";
            }
        });
    }

    // Placeholder functions
    function showApplicationDetails(id, status) {
        alert(`Show details for Application ID: ${id}, Status: ${status}`);
    }
    function downloadContract(id) {
        alert(`Downloading contract for Application ID: ${id}`);
    }

    // Load on page start
    fetchApplications();
</script>


</body>
</html>
