<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UVMS - Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/admin.css">
</head>
<body>
<!-- Header -->
<header>
    <div class="header-left">
        <div class="menu-toggle">
            <i class="fas fa-bars"></i>
        </div>
        <div class="logo">UDOM Vendor Management System</div>
    </div>
    <div class="header-right">
        <div class="logout-btn">
            <i class="fas fa-sign-out-alt"></i>
        </div>
    </div>
</header>

<!-- Sidebar -->
<div class="sidebar">
    <div class="sidebar-header">Admin Portal</div>
    <div class="sidebar-scroll-container">
        <ul class="sidebar-menu">
            <li><a href="Admindashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
            <li><a href="manage-tendersAdmin.html"><i class="fas fa-list"></i> Manage Tenders</a></li>
            <li><a href="#"><i class="fas fa-map-marker-alt"></i> Manage Plots</a></li>
            <li><a href="applicationsAdmin.html" class="active"><i class="fas fa-file-alt"></i> Applications</a></li>
            <li><a href="#"><i class="fas fa-clipboard-check"></i> Application Review</a></li>
            <li><a href="licensesAdimin.html"><i class="fas fa-certificate"></i> Licenses</a></li>
            <li><a href="#"><i class="fas fa-sync-alt"></i> License Renewals</a></li>
            <li><a href="#"><i class="fas fa-book"></i> Policies</a></li>
            <li><a href="#"><i class="fas fa-bell"></i> Notifications</a></li>
            <li><a href="#"><i class="fas fa-key"></i> Change Password</a></li>
        </ul>
    </div>
</div>

<!-- Main Content -->
<div class="main-content">
    <!-- Dashboard Content -->
    <div class="content-section">
        <div class="content-header">
            <h2>Dashboard Overview</h2>
            <p id="vendorName">Loading...</p>
        </div>

        <div class="dashboard-cards">
            <div class="card">
                <div class="card-title">Total Tenders</div>
                <div class="card-value" id="totalTenders">0</div>
            </div>
            <div class="card">
                <div class="card-title">Pending Applications</div>
                <div class="card-value" id="pendingApplications">0</div>
            </div>
            <div class="card">
                <div class="card-title">Active Licenses</div>
                <div class="card-value" id="activeLicenses">0</div>
            </div>
            <div class="card">
                <div class="card-title">Renewal Requests</div>
                <div class="card-value">7</div>
            </div>
        </div>

        <div class="content-section">
            <h3 class="section-title">Recent Applications</h3>
            <table>
                <thead>
                <tr>
                    <th>Application ID</th>
                    <th>Vendor</th>
                    <th>Plot</th>
                    <th>Date Submitted</th>
                    <th>Status</th>
                </tr>
                </thead>
                <tbody id="recentApplications">
                <tr><td colspan="5">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const apiBase = "https://uvmsapiv1.onrender.com/api";
    const token = localStorage.getItem("jwtToken");

    const authHeaders = {
        "Authorization": "Bearer " + token,
        "Content-Type": "application/json"
    };

    // Fetch Vendor Name
    fetch(`${apiBase}/vendors/dashboard`, { headers: authHeaders })
        .then(res => res.json())
        .then(data => {
            document.getElementById("vendorName").innerText = `${data.firstName} ${data.lastName}`;
        })
        .catch(() => {
            document.getElementById("vendorName").innerText = "Error loading vendor";
        });

    // Fetch Tenders
    fetch(`${apiBase}/tenders`, { headers: authHeaders })
        .then(res => res.json())
        .then(data => {
            document.getElementById("totalTenders").innerText = data.length;
        });

    // Fetch Applications (for pending count + table)
    fetch(`${apiBase}/applications`, { headers: authHeaders })
        .then(res => res.json())
        .then(data => {
            const pendingApps = data.filter(app => app.status === "PENDING");
            document.getElementById("pendingApplications").innerText = pendingApps.length;

            // Show last 5 pending apps
            const recent = pendingApps.slice(-5).reverse();
            const tbody = document.getElementById("recentApplications");
            tbody.innerHTML = "";
            recent.forEach(app => {
                const row = `
                        <tr>
                            <td>${app.application_id}</td>
                            <td>${app.vendor}</td>
                            <td>${app.plot}</td>
                            <td>${new Date(app.applicationDate).toLocaleDateString()}</td>
                            <td><span class="status-badge status-pending">${app.status}</span></td>
                        </tr>`;
                tbody.innerHTML += row;
            });
        });

    // Fetch Licenses
    fetch(`${apiBase}/licenses`, { headers: authHeaders })
        .then(res => res.json())
        .then(data => {
            const activeLicenses = data.filter(lic => lic.isActive).length;
            document.getElementById("activeLicenses").innerText = activeLicenses;
        });
</script>
</body>
</html>
