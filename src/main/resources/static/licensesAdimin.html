<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UDOM VMS - Licenses Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/admin.css">
</head>
<body>
    <!-- Header -->
    <header>
        <div class="header-left">
            <div class="menu-toggle">
                <i class="fas fa-bars"></i>
            </div>
            <div class="logo">UDOM Vendor Management System</div>
        </div>
        <div class="header-right">
            <div class="logout-btn" id="logout-button">
                <i class="fas fa-sign-out-alt"></i>
            </div>
        </div>
    </header>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">Admin Portal</div>
        <div class="sidebar-scroll-container">
            <ul class="sidebar-menu">
                <li><a href="Admindashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li><a href="manage-tendersAdmin.html"><i class="fas fa-list"></i> Manage Tenders</a></li>
                <li><a href="#"><i class="fas fa-map-marker-alt"></i> Manage Plots</a></li>
                <li><a href="applicationsAdmin.html" class="active"><i class="fas fa-file-alt"></i> Applications</a></li>
                <li><a href="#"><i class="fas fa-clipboard-check"></i> Application Review</a></li>
                <li><a href="#"><i class="fas fa-certificate"></i> Licenses</a></li>
                <li><a href="licensesAdimin.html"><i class="fas fa-sync-alt"></i> License Renewals</a></li>
                <li><a href="#"><i class="fas fa-book"></i> Policies</a></li>
                <li><a href="#"><i class="fas fa-bell"></i> Notifications</a></li>
                <li><a href="#"><i class="fas fa-key"></i> Change Password</a></li>
            </ul>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="content-section">
            <div class="content-header">
                <h2>Licenses Management</h2>
                <p>College of Informatics and Virtual Education (CIVE)</p>
            </div>
            
            <div class="search-filter">
                <input type="text" placeholder="Search licenses..." class="search-input" id="license-search">
                <select class="filter-select" id="status-filter">
                    <option value="all">All Statuses</option>
                    <option value="active">Active</option>
                    <option value="expired">Expired</option>
                    <option value="revoked">Revoked</option>
                </select>
            </div>
            
            <div class="policies-container">
                <div class="policy-categories">
                    <h3>Categories</h3>
                    <div class="category-list">
                        <div class="category-item active" data-category="all">All Licenses</div>
                        <div class="category-item" data-category="vendor">Vendor Licenses</div>
                        <div class="category-item" data-category="tender">Tender Licenses</div>
                    </div>
                </div>
                
                <div class="policies-list">
                    <h3>All Licenses</h3>
                    <p class="page-description">View and manage active vendor licenses, including expirations and revocations.</p>
                    <div class="policy-cards" id="license-cards">
                        <div class="policy-card" data-category="vendor" data-status="active">
                            <div class="policy-header">
                                <h4>License - ABC Corp</h4>
                                <span class="policy-badge vendor">Vendor</span>
                                <span class="policy-status active">Active</span>
                            </div>
                            <p class="policy-description">Issued for campus supply services.</p>
                            <div class="policy-meta">
                                <span><i class="fas fa-calendar-alt"></i> Issued: July 1, 2025</span>
                                <span><i class="fas fa-calendar-check"></i> Expires: December 31, 2025</span>
                            </div>
                            <div class="policy-actions">
                                <button class="btn btn-sm revoke-btn" data-id="lic1"><i class="fas fa-ban"></i> Revoke</button>
                                <button class="btn btn-sm view-btn"><i class="fas fa-eye"></i> View</button>
                            </div>
                        </div>
                        <div class="policy-card" data-category="tender" data-status="expired">
                            <div class="policy-header">
                                <h4>License - DEF Inc</h4>
                                <span class="policy-badge tender">Tender</span>
                                <span class="policy-status expired">Expired</span>
                            </div>
                            <p class="policy-description">Tender license for construction project.</p>
                            <div class="policy-meta">
                                <span><i class="fas fa-calendar-alt"></i> Issued: January 1, 2025</span>
                                <span><i class="fas fa-calendar-times"></i> Expired: June 30, 2025</span>
                            </div>
                            <div class="policy-actions">
                                <button class="btn btn-sm view-btn"><i class="fas fa-eye"></i> View</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const apiBase = "https://uvmsapiv1.onrender.com/api";
            const token = localStorage.getItem("jwtToken");
            const authHeaders = {
                "Authorization": "Bearer " + token,
                "Content-Type": "application/json"
            };

            // DOM refs
            const adminNameP = document.querySelector('.content-header p') || document.getElementById('adminName');
            const licenseCardsContainer = document.getElementById('license-cards');
            const searchInput = document.getElementById('license-search');
            const statusFilter = document.getElementById('status-filter');
            const categoryItems = document.querySelectorAll('.category-item');

            // In-memory store
            let vendorData = null;
            let licenses = [];
            let vendorCache = {}; // cache vendor lookups

            // ---------------------------
            // Helper: format date
            // ---------------------------
            function fmtDate(iso) {
                if (!iso) return '-';
                const d = new Date(iso);
                if (isNaN(d)) return iso;
                return d.toLocaleDateString();
            }

            // ---------------------------
            // Fetch vendor dashboard
            // ---------------------------
            async function loadVendor() {
                try {
                    const res = await fetch(`${apiBase}/vendors/dashboard`, { headers: authHeaders });
                    if (!res.ok) throw new Error('Failed to fetch vendor dashboard');
                    vendorData = await res.json();
                    if (adminNameP && vendorData) {
                        adminNameP.textContent = `${vendorData.firstName} ${vendorData.lastName}`;
                    }
                } catch (err) {
                    console.error('vendor load error', err);
                    if (adminNameP) adminNameP.textContent = 'Vendor';
                }
            }

            // ---------------------------
            // Fetch vendor details by ID (with cache)
            // ---------------------------
            async function getVendorById(id) {
                if (!id) return null;
                if (vendorCache[id]) return vendorCache[id];
                try {
                    const res = await fetch(`${apiBase}/vendors/${id}`, { headers: authHeaders });
                    if (!res.ok) throw new Error('Failed to fetch vendor ' + id);
                    const data = await res.json();
                    vendorCache[id] = data;
                    return data;
                } catch (err) {
                    console.error('vendor fetch error', err);
                    return null;
                }
            }

            // ---------------------------
            // Fetch and render licenses
            // ---------------------------
            async function loadLicenses() {
                try {
                    const res = await fetch(`${apiBase}/licenses`, { headers: authHeaders });
                    if (!res.ok) throw new Error('Failed to fetch licenses');
                    licenses = await res.json();
                    await renderLicenses(licenses);
                } catch (err) {
                    console.error('licenses load error', err);
                    licenseCardsContainer.innerHTML = `<p style="color:var(--uvms-text-secondary);padding:12px">Failed to load licenses.</p>`;
                }
            }

            // ---------------------------
            // Render license cards
            // ---------------------------
            async function renderLicenses(list) {
                const filterText = (searchInput && searchInput.value || '').toLowerCase();
                const status = statusFilter ? statusFilter.value : 'all';
                const activeCategory = Array.from(categoryItems || []).find(i => i.classList.contains('active'))?.dataset?.category || 'all';

                licenseCardsContainer.innerHTML = '';

                const filtered = list.filter(l => {
                    const licenseNum = (l.licenseNumber || '').toLowerCase();
                    const appId = l.application?.application_id ? String(l.application.application_id) : '';
                    const licId = l.license_id ? String(l.license_id) : '';

                    const matchesSearch = !filterText || licenseNum.includes(filterText) || appId.includes(filterText) || licId.includes(filterText);

                    const isActive = Boolean(l.isActive);
                    const matchesStatus = status === 'all' ||
                        (status === 'active' && isActive) ||
                        (status === 'non-active' && !isActive);

                    let matchesCategory = true;
                    if (activeCategory && activeCategory !== 'all') {
                        if (activeCategory === 'vendor') matchesCategory = true;
                        if (activeCategory === 'tender') matchesCategory = true;
                    }

                    return matchesSearch && matchesStatus && matchesCategory;
                });

                if (filtered.length === 0) {
                    licenseCardsContainer.innerHTML = `<div class="empty-state"><i class="fas fa-file-alt"></i><p>No licenses found.</p></div>`;
                    return;
                }

                for (const l of filtered) {
                    // get vendor id (either from application.vendor or license.vendor)
                    const vendorId = (typeof l.vendor === "number") ? l.vendor :
                        (typeof l.application?.vendor === "number") ? l.application.vendor :
                            (l.vendor?.vendor_id) || (l.application?.vendor?.vendor_id);

                    let companyName = "Unknown Company";
                    if (vendorId) {
                        const vendorObj = await getVendorById(vendorId);
                        if (vendorObj?.companyName) companyName = vendorObj.companyName;
                    }

                    const licenseId = l.license_id ?? '-';
                    const applicationId = l.application?.application_id || '-';
                    const licenseNumber = l.licenseNumber || '-';
                    const issueDate = fmtDate(l.issueDate);
                    const expiryDate = fmtDate(l.expiryDate);
                    const activeBadgeClass = l.isActive ? 'policy-status active' : 'policy-status expired';
                    const activeText = l.isActive ? 'Active' : 'Non-active';

                    const card = document.createElement('div');
                    card.className = `policy-card`;
                    card.setAttribute('data-status', l.isActive ? 'active' : 'non-active');
                    card.setAttribute('data-license-id', licenseId);

                    card.innerHTML = `
                <div class="policy-header">
                  <h4>License - ${companyName}</h4>
                  <span class="policy-badge vendor">Vendor</span>
                  <span class="${activeBadgeClass}">${activeText}</span>
                </div>
                <p class="policy-description">${l.application?.feedback ? escapeHtml(l.application.feedback).slice(0,120) : ''}</p>
                <div class="policy-meta">
                  <span><i class="fas fa-hashtag"></i> License ID: <strong>${licenseId}</strong></span>
                  <span><i class="fas fa-file-alt"></i> Application ID: <strong>${applicationId}</strong></span>
                  <span><i class="fas fa-id-badge"></i> License No: <strong>${licenseNumber}</strong></span>
                </div>
                <div class="policy-meta" style="margin-top:8px;">
                  <span><i class="fas fa-calendar-alt"></i> Issued: ${issueDate}</span>
                  <span><i class="fas fa-calendar-check"></i> Expires: ${expiryDate}</span>
                </div>
                <div class="policy-actions" style="margin-top:12px;">
                  <button class="btn btn-sm view-btn" data-id="${licenseId}"><i class="fas fa-eye"></i> View</button>
                  <button class="btn btn-sm btn-primary download-btn" data-path="${l.licenseFilePath || ''}"><i class="fas fa-download"></i> Download</button>
                </div>
            `;

                    licenseCardsContainer.appendChild(card);
                }

                // Attach listeners
                licenseCardsContainer.querySelectorAll('.view-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const licId = Number(btn.getAttribute('data-id'));
                        openLicenseModal(licId);
                    });
                });

                licenseCardsContainer.querySelectorAll('.download-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const path = btn.getAttribute('data-path');
                        if (!path) { alert('No license file available'); return; }
                        window.open(path, '_blank');
                    });
                });
            }

            // ---------------------------
            // Escape HTML
            // ---------------------------
            function escapeHtml(s){
                if (!s) return '';
                return s.replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[m]);
            }

            // ---------------------------
            // Modal
            // ---------------------------
            function buildModalHtml(lic, vendorObj) {
                const company = vendorObj || lic.vendor || lic.application?.vendor || {};
                const app = lic.application || {};

                return `
            <div class="modal" id="licenseDetailModal" style="display:flex;">
              <div class="modal-content">
                <div class="modal-header">
                  <h3>License Details</h3>
                  <span class="close-modal" id="closeLicenseModal">&times;</span>
                </div>
                <div class="modal-body" style="max-height:60vh; overflow:auto; text-align:left;">
                  <p><strong>License ID:</strong> ${lic.license_id}</p>
                  <p><strong>License Number:</strong> ${lic.licenseNumber || '-'}</p>
                  <p><strong>Application ID:</strong> ${app.application_id || '-'}</p>
                  <p><strong>Company:</strong> ${company.companyName || '-'}</p>
                  <p><strong>Vendor Owner:</strong> ${company.firstName || '-'} ${company.lastName || '-'}</p>
                  <p><strong>TIN:</strong> ${company.tinNumber || '-'}</p>
                  <p><strong>Business Address:</strong><br>${(company.businessAddress || '-').replace(/\n/g,'<br>')}</p>
                  <p><strong>Issue Date:</strong> ${fmtDate(lic.issueDate)}</p>
                  <p><strong>Expiry Date:</strong> ${fmtDate(lic.expiryDate)}</p>
                  <p><strong>Feedback:</strong> ${escapeHtml(app.feedback || '')}</p>
                  <p><strong>License File Path:</strong> ${lic.licenseFilePath || 'N/A'}</p>
                  <p><strong>Is Active:</strong> ${lic.isActive ? 'Yes' : 'No'}</p>
                  <hr>
                  <small style="color:var(--text-secondary)">* Use the buttons below to expire this license or cancel.</small>
                </div>
                <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:12px;">
                  ${lic.isActive ? `<button class="btn btn-sm btn-warning" id="expireLicenseBtn">Expire</button>` : ''}
                  <button class="btn btn-sm" id="closeCancelBtn">Cancel</button>
                </div>
              </div>
            </div>
        `;
            }

            async function openLicenseModal(licenseId) {
                const lic = licenses.find(x => Number(x.license_id) === Number(licenseId));
                if (!lic) { alert('License not found'); return; }

                const vendorId = (typeof lic.vendor === "number") ? lic.vendor :
                    (typeof lic.application?.vendor === "number") ? lic.application.vendor :
                        (lic.vendor?.vendor_id) || (lic.application?.vendor?.vendor_id);

                const vendorObj = vendorId ? await getVendorById(vendorId) : null;

                const existing = document.getElementById('licenseDetailModal');
                if (existing) existing.remove();

                const wrapper = document.createElement('div');
                wrapper.innerHTML = buildModalHtml(lic, vendorObj);
                document.body.appendChild(wrapper.firstElementChild);

                document.getElementById('closeLicenseModal')?.addEventListener('click', closeLicenseModal);
                document.getElementById('closeCancelBtn')?.addEventListener('click', closeLicenseModal);

                document.getElementById('expireLicenseBtn')?.addEventListener('click', async () => {
                    if (!confirm('Mark this license as expired (set isActive=false)?')) return;
                    await expireLicense(lic.license_id);
                });

                document.getElementById('licenseDetailModal').addEventListener('click', (e) => {
                    if (e.target.id === 'licenseDetailModal') closeLicenseModal();
                });
            }

            function closeLicenseModal() {
                document.getElementById('licenseDetailModal')?.remove();
            }

            // ---------------------------
            // Expire license
            // ---------------------------
            async function expireLicense(licenseId) {
                try {
                    const lic = licenses.find(x => Number(x.license_id) === Number(licenseId));
                    if (!lic) { alert('License not found'); return; }

                    const updated = { ...lic, isActive: false };

                    const res = await fetch(`${apiBase}/licenses/${licenseId}`, {
                        method: 'PUT',
                        headers: authHeaders,
                        body: JSON.stringify(updated)
                    });

                    if (!res.ok) {
                        const text = await res.text();
                        throw new Error(text || 'Failed to update license');
                    }

                    alert('License marked as non-active');
                    closeLicenseModal();
                    await loadLicenses();
                } catch (err) {
                    console.error('expire error', err);
                    alert('Failed to update license: ' + (err.message || 'unknown'));
                }
            }

            // ---------------------------
            // Filters & search
            // ---------------------------
            searchInput?.addEventListener('input', () => renderLicenses(licenses));
            statusFilter?.addEventListener('change', () => renderLicenses(licenses));
            categoryItems.forEach(item => item.addEventListener('click', function() {
                categoryItems.forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                renderLicenses(licenses);
            }));

            // ---------------------------
            // Initial load
            // ---------------------------
            (async function init() {
                await loadVendor();
                await loadLicenses();
            })();
        });
    </script>



</body>
</html>